<!-- Copyright Yahoo. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root. -->

![Vespa logo](https://vespa.ai/assets/vespa-logo-color.png)

# Vespa sample application - search as you type

Uses N-grams to simulate substring search.


## Steps

**Validate environment, must be minimum 4G:**

Refer to [Docker memory](https://docs.vespa.ai/en/operations/docker-containers.html#memory)
for details and troubleshooting:
<pre>
$ docker info | grep "Total Memory"
</pre>


**Clone sample apps and documentation**

<pre data-test="exec">
$ git clone --depth 1 https://github.com/vespa-engine/sample-apps.git
$ git clone --depth 1 https://github.com/vespa-engine/documentation.git
</pre>


**Generate feed file**

Generate _open\_index.json_ in the documentation repository and move this file to the directory for the _search-as-you-type_ application.
<pre data-test="exec">
$ cd documentation/
$ bundle install
$ bundle exec jekyll build -p _plugins-vespafeed
$ cd ../sample-apps/incremental-search/search-as-you-type/
$ mv ../../../documentation/open_index.json ./
</pre>


**Run docker container**

<pre data-test="exec">
$ docker pull vespaengine/vespa
$ docker run --detach --name vespa --hostname vespa-example \
  --publish 8080:8080 --publish 19071:19071 \
  vespaengine/vespa
</pre>


**Wait for the configserver to start**

<pre data-test="exec" data-test-wait-for="200 OK">
$ curl -s --head http://localhost:19071/ApplicationStatus
</pre>


**Build and deploy the application**

<pre data-test="exec">
$ mvn clean package
$ curl --header Content-Type:application/zip --data-binary @target/application.zip \
  localhost:19071/application/v2/tenant/default/prepareandactivate
</pre>


**Wait for the application to start**

<pre data-test="exec" data-test-wait-for="200 OK">
$ curl -s --head http://localhost:8080/ApplicationStatus
</pre>


**Feed documents to the application**

<pre data-test="exec">
$ python3 feed_to_vespa.py
</pre>


**Check out the website**

Open <http://localhost:8080/site/> in a browser.
To validate the site is up:
<pre data-test="exec" data-test-assert-contains="search as you type">
$ curl -s http://localhost:8080/site/
</pre>


**Shutdown and remove the Docker container**

<pre data-test="after">
$ docker rm -f vespa
</pre>


## Details

### N-grams

Substring searches are slow when working on large amounts of data. However an N-gram search can be used as a faster but less precise substring-like search.
The fields _title_ and _content_ are reindexed to create the fields _gram\_title_ and _gram\_content_ with an N-gram index. In this example the gram size is set to 3, but any value can be used. A lower gram size will get more hits, but may also find more irrelevant hits.

### Weighted combination of searches

If we can get a hit on a whole word, this is most likely a more relevant hit than a hit on only a part of a word. Therefore we search through both the _default_ fieldset and the _grams_ fieldset and we weight hits on the _default_ fieldset higher than other hits. These weights can be seen in the _weighted\_doc\_rank_ rank profile.

### Highlighting

Text highlights are generated by including `summary: dynamic` in a field. As searches on _default_ and _grams_ match with different parts of the text, the highlights of these matches will also be different. The line `contentScore*highlightWeight >= gramContentScore` in the file _src/main/resources/site/js/main.js_ decides which of these highlights should be shown on the website. The variable _highlightWeight_ can be tweaked to prioritize _default_ highlighting or _grams_ highlighting.
